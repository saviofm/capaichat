sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel"],function(e,t){"use strict";return e.extend("capaichatui.controller.InitialRightScreen",{onInit:function(){const e=new t;e.setData({conversationId:"",messageId:"",message_time:"",user_id:"",user_query:"",chatHistory:[],isBusy:false,enableTextArea:true});this.getView().setModel(e,"chatModel");this.getUserInfo();this.oOwnerComponent=this.getOwnerComponent();this.oRouter=this.oOwnerComponent.getRouter();this.oRouter.getRoute("home").attachPatternMatched(this.onRouteMatched,this)},getUserInfo:function(){const e=this.getBaseURL()+"/user-api/currentUser";var s=new t;var o={firstname:"Dummy",lastname:"User",email:"dummy.user@com",name:"dummy.user@com",displayName:"Dummy User (dummy.user@com)"};s.loadData(e);s.dataLoaded().then(()=>{console.log(s.getData());if(!s.getData().email){s.setData(o)}this.getView().setModel(s,"userInfo")}).catch(()=>{s.setData(o);this.getView().setModel(s,"userInfo")})},getBaseURL:function(){var e=this.getOwnerComponent().getManifestEntry("/sap.app/id");var t=e.replaceAll(".","/");var s=jQuery.sap.getModulePath(t);return s},onRouteMatched(e){this.clearChatHistory()},clearChatHistory:function(){const e=this.getView().getModel("chatModel");const t="/chatHistory";const s=[];e.setProperty(t,s)},onSendMessage:function(e){this.setBusy(true);this.setEnableTextArea(false);const t=e.getParameter("value");const s=e.getSource();const o=this.getOwnerComponent().getRouter();this.setUserQuestionInToChatMessage(t);const n=this.getView().getModel("chatModel");const r=n.getProperty("/conversationId");const a=JSON.stringify({conversationId:r,messageId:n.getProperty("/messageId"),message_time:n.getProperty("/message_time"),user_id:n.getProperty("/user_id"),user_query:n.getProperty("/user_query")});this.sendMessage(a).then(e=>{this.setBackendResponseInToChatMessage(e);setTimeout(()=>{o.navTo("conversation",{conversationID:r})},1e3)}).catch(e=>{console.log(e)}).finally(()=>{this.setBusy(false);this.setEnableTextArea(true)})},sendMessage:function(e){return new Promise((t,s)=>{$.ajax({url:this.getBaseURL()+"/odata/v4/chat/getChatRagResponse",type:"POST",contentType:"application/json",async:true,data:e,success:function(e,o,n){console.log(n);if(n.status===200||n.status===201){t(n.responseJSON)}else{s(n.responseJSON)}},error:function(e,t){if(e){if(e.responseJSON){const t=e.responseJSON.message||e.responseJSON.status_msg;s(t)}else{s(e.responseText)}}else{s(t)}}})})},setBackendResponseInToChatMessage(e){const t=this.getView().getModel("chatModel");const s=t.getProperty("/conversationId");const o={conversationId:s,messageId:self.crypto.randomUUID(),message_time:new Date(e.messageTime),content:e.content,user_id:"",user_role:e.role,icon_path:"sap-icon://da-2",initials:""};const n="/chatHistory";const r=t.getProperty(n);r.push(o);t.setProperty(n,r)},setBusy:function(e){const t="/isBusy";this.getView().getModel("chatModel").setProperty(t,e)},setEnableTextArea:function(e){const t="/enableTextArea";this.getView().getModel("chatModel").setProperty(t,e)},setUserQuestionInToChatMessage(e){const t=this.getView().getModel("chatModel");const s=this.getView().getModel("userInfo");t.setProperty("/conversationId",self.crypto.randomUUID());t.setProperty("/messageId",self.crypto.randomUUID());t.setProperty("/message_time",(new Date).toISOString());t.setProperty("/user_query",e);t.setProperty("/user_id",s.getProperty("/email"));const o={conversationId:t.getProperty("/conversationId"),messageId:t.getProperty("/messageId"),message_time:new Date(t.getProperty("/message_time")),content:e,user_id:t.getProperty("/user_id"),user_role:"You",icon_path:"",initials:s.getProperty("/firstname").charAt(0)+s.getProperty("/lastname").charAt(0)};const n="/chatHistory";const r=t.getProperty(n);r.push(o);t.setProperty(n,r)},onListUpdateFinished:function(e){const t=e.getSource().getItems();if(t.length===0){return}t[t.length-1].focus()}})});